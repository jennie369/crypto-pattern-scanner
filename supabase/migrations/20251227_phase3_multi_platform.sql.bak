-- ============================================================================
-- GEMRAL AI LIVESTREAM - PHASE 3: MULTI-PLATFORM INTEGRATION
-- Extends Phase 1 foundation for TikTok, Facebook, and Restream
-- ============================================================================

-- Enable UUID extension if not exists
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- 1. LIVESTREAM GIFTS TABLE
-- Separate table for gifts (not embedded in comments)
-- ============================================================================

CREATE TABLE IF NOT EXISTS livestream_gifts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID REFERENCES livestream_sessions(id) ON DELETE CASCADE,

  -- User info
  user_id UUID REFERENCES auth.users(id),
  platform TEXT NOT NULL CHECK (platform IN ('gemral', 'tiktok', 'facebook')),
  platform_user_id TEXT,
  platform_username TEXT NOT NULL,

  -- Gift details
  gift_id TEXT NOT NULL,
  gift_name TEXT NOT NULL,
  gift_count INTEGER DEFAULT 1,

  -- Value in different currencies
  diamond_value INTEGER DEFAULT 0,  -- TikTok diamonds
  star_value INTEGER DEFAULT 0,     -- Facebook stars
  gem_value INTEGER DEFAULT 0,      -- Gemral gems
  value_vnd INTEGER DEFAULT 0,      -- Converted to VND

  -- Metadata (icon, animation, etc.)
  metadata JSONB DEFAULT '{}',

  -- Tracking
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for gifts
CREATE INDEX IF NOT EXISTS idx_livestream_gifts_session ON livestream_gifts(session_id);
CREATE INDEX IF NOT EXISTS idx_livestream_gifts_user ON livestream_gifts(user_id);
CREATE INDEX IF NOT EXISTS idx_livestream_gifts_platform ON livestream_gifts(platform);
CREATE INDEX IF NOT EXISTS idx_livestream_gifts_created ON livestream_gifts(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_livestream_gifts_value ON livestream_gifts(value_vnd DESC);

-- Enable RLS
ALTER TABLE livestream_gifts ENABLE ROW LEVEL SECURITY;

-- Policies for gifts
DROP POLICY IF EXISTS "Anyone can view gifts" ON livestream_gifts;
CREATE POLICY "Anyone can view gifts" ON livestream_gifts
  FOR SELECT USING (true);

DROP POLICY IF EXISTS "Authenticated can create gifts" ON livestream_gifts;
CREATE POLICY "Authenticated can create gifts" ON livestream_gifts
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

DROP POLICY IF EXISTS "Admins can manage gifts" ON livestream_gifts;
CREATE POLICY "Admins can manage gifts" ON livestream_gifts
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid()
      AND (tier = 'ADMIN' OR role = 'admin' OR is_admin = true)
    )
  );

-- Enable realtime for gifts
ALTER PUBLICATION supabase_realtime ADD TABLE livestream_gifts;

-- ============================================================================
-- 2. PLATFORM CONNECTIONS TABLE
-- Track linked platform accounts for cross-platform identity
-- ============================================================================

CREATE TABLE IF NOT EXISTS user_platform_connections (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Platform info
  platform TEXT NOT NULL CHECK (platform IN ('tiktok', 'facebook', 'youtube', 'shopee')),
  platform_user_id TEXT NOT NULL,
  platform_username TEXT,
  platform_display_name TEXT,
  platform_avatar TEXT,

  -- Status
  is_verified BOOLEAN DEFAULT false,
  is_follower BOOLEAN DEFAULT false,
  is_subscriber BOOLEAN DEFAULT false,

  -- OAuth tokens (encrypted)
  access_token_encrypted TEXT,
  refresh_token_encrypted TEXT,
  token_expires_at TIMESTAMPTZ,

  -- Stats
  follower_count INTEGER DEFAULT 0,

  -- Metadata
  metadata JSONB DEFAULT '{}',
  linked_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Unique constraint
  UNIQUE(user_id, platform)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_platform_connections_user ON user_platform_connections(user_id);
CREATE INDEX IF NOT EXISTS idx_platform_connections_platform ON user_platform_connections(platform);
CREATE INDEX IF NOT EXISTS idx_platform_connections_lookup
  ON user_platform_connections(platform, platform_user_id);

-- Enable RLS
ALTER TABLE user_platform_connections ENABLE ROW LEVEL SECURITY;

-- Policies
DROP POLICY IF EXISTS "Users can view own connections" ON user_platform_connections;
CREATE POLICY "Users can view own connections" ON user_platform_connections
  FOR SELECT USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can manage own connections" ON user_platform_connections;
CREATE POLICY "Users can manage own connections" ON user_platform_connections
  FOR ALL USING (auth.uid() = user_id);

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION update_platform_connections_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_platform_connections_updated_at ON user_platform_connections;
CREATE TRIGGER trigger_platform_connections_updated_at
  BEFORE UPDATE ON user_platform_connections
  FOR EACH ROW
  EXECUTE FUNCTION update_platform_connections_updated_at();

-- ============================================================================
-- 3. TEMPORARY USERS TABLE
-- For platform users who haven't linked their Gemral account yet
-- ============================================================================

CREATE TABLE IF NOT EXISTS temporary_platform_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- Platform info
  platform TEXT NOT NULL CHECK (platform IN ('tiktok', 'facebook', 'youtube')),
  platform_user_id TEXT NOT NULL,
  platform_username TEXT,
  display_name TEXT,
  avatar_url TEXT,

  -- Merge tracking
  merged_to_user_id UUID REFERENCES auth.users(id),
  merged_at TIMESTAMPTZ,

  -- Metadata
  first_seen_at TIMESTAMPTZ DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}',

  -- Unique constraint per platform
  UNIQUE(platform, platform_user_id)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_temp_users_platform
  ON temporary_platform_users(platform, platform_user_id);
CREATE INDEX IF NOT EXISTS idx_temp_users_merged
  ON temporary_platform_users(merged_to_user_id) WHERE merged_to_user_id IS NOT NULL;

-- Enable RLS
ALTER TABLE temporary_platform_users ENABLE ROW LEVEL SECURITY;

-- Anyone can read temp users (for comment display)
DROP POLICY IF EXISTS "Anyone can view temp users" ON temporary_platform_users;
CREATE POLICY "Anyone can view temp users" ON temporary_platform_users
  FOR SELECT USING (true);

-- System can insert/update
DROP POLICY IF EXISTS "System can manage temp users" ON temporary_platform_users;
CREATE POLICY "System can manage temp users" ON temporary_platform_users
  FOR ALL USING (true);

-- ============================================================================
-- 4. STREAM HEALTH LOGS TABLE
-- Track stream health and issues
-- ============================================================================

CREATE TABLE IF NOT EXISTS stream_health_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  session_id UUID REFERENCES livestream_sessions(id) ON DELETE CASCADE,

  -- Platform info
  platform TEXT NOT NULL CHECK (platform IN ('gemral', 'tiktok', 'facebook', 'restream')),

  -- Health metrics
  bitrate INTEGER,
  fps REAL,
  resolution TEXT,
  latency_ms INTEGER,
  dropped_frames INTEGER,

  -- Status
  status TEXT CHECK (status IN ('healthy', 'warning', 'critical', 'offline')),
  issue_type TEXT, -- 'low_bitrate', 'high_latency', 'connection_lost', etc.
  issue_details TEXT,

  -- Timestamp
  logged_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_stream_health_session ON stream_health_logs(session_id);
CREATE INDEX IF NOT EXISTS idx_stream_health_logged ON stream_health_logs(logged_at DESC);
CREATE INDEX IF NOT EXISTS idx_stream_health_status
  ON stream_health_logs(session_id, status) WHERE status != 'healthy';

-- Enable RLS
ALTER TABLE stream_health_logs ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Admins can view health logs" ON stream_health_logs;
CREATE POLICY "Admins can view health logs" ON stream_health_logs
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM user_profiles
      WHERE id = auth.uid()
      AND (tier = 'ADMIN' OR role = 'admin' OR is_admin = true)
    )
  );

DROP POLICY IF EXISTS "System can insert health logs" ON stream_health_logs;
CREATE POLICY "System can insert health logs" ON stream_health_logs
  FOR INSERT WITH CHECK (true);

-- ============================================================================
-- 5. EXTEND LIVESTREAM_SESSIONS FOR MULTI-PLATFORM
-- ============================================================================

-- Add columns for multi-platform streaming
DO $$
BEGIN
  -- Restream configuration
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_sessions' AND column_name = 'restream_enabled') THEN
    ALTER TABLE livestream_sessions ADD COLUMN restream_enabled BOOLEAN DEFAULT false;
  END IF;

  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_sessions' AND column_name = 'restream_channels') THEN
    ALTER TABLE livestream_sessions ADD COLUMN restream_channels JSONB DEFAULT '[]';
  END IF;

  -- Per-platform viewer counts
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_sessions' AND column_name = 'viewer_counts') THEN
    ALTER TABLE livestream_sessions ADD COLUMN viewer_counts JSONB DEFAULT '{
      "gemral": 0,
      "tiktok": 0,
      "facebook": 0,
      "total": 0
    }';
  END IF;

  -- Product showcase settings
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_sessions' AND column_name = 'product_showcase') THEN
    ALTER TABLE livestream_sessions ADD COLUMN product_showcase JSONB DEFAULT '{
      "enabled": true,
      "current_product_id": null,
      "queue": []
    }';
  END IF;

  -- Gift settings
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_sessions' AND column_name = 'gift_settings') THEN
    ALTER TABLE livestream_sessions ADD COLUMN gift_settings JSONB DEFAULT '{
      "enabled": true,
      "minimum_gem": 1,
      "goal_gem": 0,
      "goal_progress": 0
    }';
  END IF;
END $$;

-- ============================================================================
-- 6. UPDATE LIVESTREAM_COMMENTS FOR MULTI-PLATFORM
-- ============================================================================

-- Add metadata column if not exists
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_comments' AND column_name = 'metadata') THEN
    ALTER TABLE livestream_comments ADD COLUMN metadata JSONB DEFAULT '{}';
  END IF;

  -- Add tier column for user tier display
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_comments' AND column_name = 'user_tier') THEN
    ALTER TABLE livestream_comments ADD COLUMN user_tier TEXT;
  END IF;

  -- Add badges column
  IF NOT EXISTS (SELECT 1 FROM information_schema.columns
    WHERE table_name = 'livestream_comments' AND column_name = 'badges') THEN
    ALTER TABLE livestream_comments ADD COLUMN badges JSONB DEFAULT '[]';
  END IF;
END $$;

-- ============================================================================
-- 7. HELPER FUNCTIONS FOR MULTI-PLATFORM
-- ============================================================================

-- Function to find user by platform ID
CREATE OR REPLACE FUNCTION find_user_by_platform(
  p_platform TEXT,
  p_platform_user_id TEXT
)
RETURNS TABLE (
  user_id UUID,
  display_name TEXT,
  avatar_url TEXT,
  tier TEXT,
  is_temporary BOOLEAN
) AS $$
BEGIN
  -- First check user_platform_connections
  RETURN QUERY
  SELECT
    upc.user_id,
    up.display_name,
    up.avatar_url,
    up.tier,
    false AS is_temporary
  FROM user_platform_connections upc
  JOIN user_profiles up ON up.id = upc.user_id
  WHERE upc.platform = p_platform
    AND upc.platform_user_id = p_platform_user_id
  LIMIT 1;

  IF NOT FOUND THEN
    -- Check temporary users
    RETURN QUERY
    SELECT
      tpu.id AS user_id,
      tpu.display_name,
      tpu.avatar_url,
      'FREE' AS tier,
      true AS is_temporary
    FROM temporary_platform_users tpu
    WHERE tpu.platform = p_platform
      AND tpu.platform_user_id = p_platform_user_id
      AND tpu.merged_to_user_id IS NULL
    LIMIT 1;
  END IF;
END;
$$ LANGUAGE plpgsql;

-- Function to merge temporary user into permanent account
CREATE OR REPLACE FUNCTION merge_temporary_user(
  p_temp_user_id UUID,
  p_target_user_id UUID
)
RETURNS VOID AS $$
BEGIN
  -- Update comments to point to real user
  UPDATE livestream_comments
  SET user_id = p_target_user_id
  WHERE user_id = p_temp_user_id;

  -- Update gifts to point to real user
  UPDATE livestream_gifts
  SET user_id = p_target_user_id
  WHERE user_id = p_temp_user_id;

  -- Mark temporary user as merged
  UPDATE temporary_platform_users
  SET
    merged_to_user_id = p_target_user_id,
    merged_at = NOW()
  WHERE id = p_temp_user_id;
END;
$$ LANGUAGE plpgsql;

-- Function to update viewer counts
CREATE OR REPLACE FUNCTION update_viewer_counts(
  p_session_id UUID,
  p_platform TEXT,
  p_count INTEGER
)
RETURNS VOID AS $$
DECLARE
  v_counts JSONB;
  v_total INTEGER;
BEGIN
  -- Get current counts
  SELECT viewer_counts INTO v_counts
  FROM livestream_sessions
  WHERE id = p_session_id;

  -- Update platform count
  v_counts = jsonb_set(v_counts, ARRAY[p_platform], to_jsonb(p_count));

  -- Calculate total
  v_total = COALESCE((v_counts->>'gemral')::INTEGER, 0)
          + COALESCE((v_counts->>'tiktok')::INTEGER, 0)
          + COALESCE((v_counts->>'facebook')::INTEGER, 0);
  v_counts = jsonb_set(v_counts, ARRAY['total'], to_jsonb(v_total));

  -- Update session
  UPDATE livestream_sessions
  SET
    viewer_counts = v_counts,
    stats = jsonb_set(
      stats,
      '{current_viewers}',
      to_jsonb(v_total)
    )
  WHERE id = p_session_id;

  -- Update peak if needed
  UPDATE livestream_sessions
  SET stats = jsonb_set(
    stats,
    '{peak_viewers}',
    to_jsonb(v_total)
  )
  WHERE id = p_session_id
    AND COALESCE((stats->>'peak_viewers')::INTEGER, 0) < v_total;
END;
$$ LANGUAGE plpgsql;

-- Function to get gift leaderboard
CREATE OR REPLACE FUNCTION get_gift_leaderboard(
  p_session_id UUID,
  p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
  rank INTEGER,
  user_id UUID,
  platform TEXT,
  platform_username TEXT,
  avatar TEXT,
  total_gifts INTEGER,
  total_value INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    ROW_NUMBER() OVER (ORDER BY SUM(lg.value_vnd) DESC)::INTEGER AS rank,
    lg.user_id,
    lg.platform,
    lg.platform_username,
    lg.metadata->>'avatar' AS avatar,
    SUM(lg.gift_count)::INTEGER AS total_gifts,
    SUM(lg.value_vnd)::INTEGER AS total_value
  FROM livestream_gifts lg
  WHERE lg.session_id = p_session_id
  GROUP BY lg.user_id, lg.platform, lg.platform_username, lg.metadata->>'avatar'
  ORDER BY total_value DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;

-- Trigger to update gift stats when gift is added
CREATE OR REPLACE FUNCTION update_session_gift_stats_v2()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE livestream_sessions
  SET stats = jsonb_set(
    jsonb_set(
      stats,
      '{total_gifts}',
      to_jsonb(COALESCE((stats->>'total_gifts')::INTEGER, 0) + NEW.gift_count)
    ),
    '{total_gift_value}',
    to_jsonb(COALESCE((stats->>'total_gift_value')::INTEGER, 0) + COALESCE(NEW.value_vnd, 0))
  )
  WHERE id = NEW.session_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_gift_stats_v2 ON livestream_gifts;
CREATE TRIGGER trigger_update_gift_stats_v2
  AFTER INSERT ON livestream_gifts
  FOR EACH ROW
  EXECUTE FUNCTION update_session_gift_stats_v2();

-- ============================================================================
-- 8. GEM DEDUCTION FUNCTION
-- For gift purchases
-- ============================================================================

-- First check if user_wallets exists
DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'user_wallets') THEN
    -- Create or replace the deduct_gems function
    EXECUTE $func$
    CREATE OR REPLACE FUNCTION deduct_gems(
      p_user_id UUID,
      p_amount INTEGER,
      p_reason TEXT DEFAULT 'Gift'
    )
    RETURNS BOOLEAN AS $inner$
    DECLARE
      v_current_balance INTEGER;
    BEGIN
      -- Get current balance
      SELECT gem_balance INTO v_current_balance
      FROM user_wallets
      WHERE user_id = p_user_id;

      IF v_current_balance IS NULL OR v_current_balance < p_amount THEN
        RETURN false;
      END IF;

      -- Deduct
      UPDATE user_wallets
      SET gem_balance = gem_balance - p_amount
      WHERE user_id = p_user_id;

      -- Log transaction if wallet_transactions table exists
      IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'wallet_transactions') THEN
        INSERT INTO wallet_transactions (user_id, type, amount, reason)
        VALUES (p_user_id, 'DEBIT', p_amount, p_reason);
      END IF;

      RETURN true;
    END;
    $inner$ LANGUAGE plpgsql;
    $func$;
  END IF;
END $$;

-- ============================================================================
-- DONE
-- ============================================================================

COMMENT ON TABLE livestream_gifts IS 'Phase 3: Multi-platform gift tracking';
COMMENT ON TABLE user_platform_connections IS 'Phase 3: Cross-platform user identity';
COMMENT ON TABLE temporary_platform_users IS 'Phase 3: Temporary profiles for external platform users';
COMMENT ON TABLE stream_health_logs IS 'Phase 3: Stream health monitoring';
