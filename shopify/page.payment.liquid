{% comment %}
  GEM Payment Page Template
  URL: /pages/thanh-toan?order=ORDER_NUMBER
  Hi·ªÉn th·ªã QR code + th√¥ng tin chuy·ªÉn kho·∫£n + auto-check status
{% endcomment %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh to√°n ƒë∆°n h√†ng - {{ shop.name }}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
      min-height: 100vh;
      color: #fff;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
    }
    .logo {
      text-align: center;
      padding: 20px 0;
    }
    .logo img {
      height: 50px;
    }
    .payment-box {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 {
      color: #FFBD59;
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .header p {
      color: #888;
      font-size: 14px;
    }
    .order-number {
      background: rgba(255,189,89,0.1);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 20px;
    }
    .order-number span {
      color: #888;
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    .order-number strong {
      color: #FFBD59;
      font-size: 24px;
      font-weight: 700;
    }
    .qr-container {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .qr-container img {
      max-width: 220px;
      height: auto;
    }
    .qr-tip {
      color: #666;
      font-size: 12px;
      margin-top: 12px;
    }
    .countdown-box {
      background: rgba(255,189,89,0.1);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 20px;
    }
    .countdown-label {
      color: #888;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .countdown-timer {
      color: #FFBD59;
      font-size: 32px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }
    .countdown-timer.urgent {
      color: #ff4444;
    }
    .countdown-note {
      color: #666;
      font-size: 11px;
      margin-top: 4px;
    }
    .divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 20px 0;
    }
    .bank-info {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 16px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      color: #888;
      font-size: 13px;
    }
    .info-value {
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .info-value.highlight {
      color: #FFBD59;
      font-size: 16px;
      font-weight: 700;
    }
    .copy-btn {
      background: transparent;
      border: 1px solid #FFBD59;
      color: #FFBD59;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .copy-btn:hover {
      background: #FFBD59;
      color: #1a1a2e;
    }
    .copy-btn.copied {
      background: #4CAF50;
      border-color: #4CAF50;
      color: #fff;
    }
    .warning-box {
      background: rgba(255,189,89,0.1);
      border-left: 3px solid #FFBD59;
      padding: 12px 16px;
      margin-top: 20px;
      font-size: 13px;
      color: #ccc;
      border-radius: 0 8px 8px 0;
    }
    .warning-box strong {
      color: #FFBD59;
    }
    .status-box {
      text-align: center;
      padding: 20px;
      margin-top: 20px;
    }
    .status-pending {
      color: #FFBD59;
      font-size: 14px;
    }
    .status-pending .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #FFBD59;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status-paid {
      background: rgba(0,240,255,0.1);
      border-radius: 16px;
      padding: 30px;
    }
    .status-paid .icon {
      font-size: 60px;
      margin-bottom: 12px;
    }
    .status-paid h2 {
      color: #00F0FF;
      font-size: 20px;
      margin-bottom: 8px;
    }
    .status-paid p {
      color: #888;
      font-size: 14px;
    }
    .error-box {
      text-align: center;
      padding: 40px 20px;
    }
    .error-box .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .error-box h2 {
      color: #ff6b6b;
      font-size: 18px;
      margin-bottom: 8px;
    }
    .error-box p {
      color: #888;
      font-size: 14px;
    }
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    .loading .spinner-large {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,189,89,0.2);
      border-top-color: #FFBD59;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 24px;
      color: #FFBD59;
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Logo -->
    <div class="logo">
      {% if shop.logo %}
        <img src="{{ shop.logo | image_url: width: 200 }}" alt="{{ shop.name }}">
      {% else %}
        <h2 style="color: #FFBD59;">{{ shop.name }}</h2>
      {% endif %}
    </div>

    <!-- Main Content - populated by JavaScript -->
    <div class="payment-box" id="payment-content">
      <div class="loading">
        <div class="spinner-large"></div>
        <p style="color: #888;">ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</p>
      </div>
    </div>

    <a href="/" class="back-link">‚Üê Quay v·ªÅ trang ch·ªß</a>
  </div>

  <script>
    (function() {
      var SUPABASE_URL = 'https://pgfkbcnzqozzkohwbgbk.supabase.co';
      var container = document.getElementById('payment-content');

      // Get order number from URL
      var urlParams = new URLSearchParams(window.location.search);
      var orderNumber = urlParams.get('order') || urlParams.get('don-hang');

      if (!orderNumber) {
        showError('Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng', 'Vui l√≤ng ki·ªÉm tra l·∫°i link ho·∫∑c li√™n h·ªá h·ªó tr·ª£.');
        return;
      }

      // Fetch payment info
      fetchPaymentInfo();

      function fetchPaymentInfo() {
        fetch(SUPABASE_URL + '/functions/v1/payment-status?order=' + orderNumber)
          .then(function(res) { return res.json(); })
          .then(function(response) {
            if (response.success && response.data) {
              renderPaymentInfo(response.data);
            } else {
              showError('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng', 'ƒê∆°n h√†ng #' + orderNumber + ' kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.');
            }
          })
          .catch(function(err) {
            console.error('Error:', err);
            showError('L·ªói k·∫øt n·ªëi', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
          });
      }

      function renderPaymentInfo(data) {
        if (data.is_paid) {
          showPaid();
          return;
        }

        var amount = data.total_amount || 0;
        var qrUrl = 'https://img.vietqr.io/image/VCB-1074286868-compact2.png?amount=' + amount + '&addInfo=DH' + orderNumber + '&accountName=CT%20TNHH%20GEM%20CAPITAL%20HOLDING';
        var expiresAt = data.expires_at ? new Date(data.expires_at) : new Date(Date.now() + 24*60*60*1000);

        container.innerHTML = [
          '<div class="header">',
          '  <h1>üí≥ Thanh to√°n chuy·ªÉn kho·∫£n</h1>',
          '  <p>Qu√©t m√£ QR ho·∫∑c chuy·ªÉn kho·∫£n th·ªß c√¥ng</p>',
          '</div>',
          '',
          '<div class="order-number">',
          '  <span>M√£ ƒë∆°n h√†ng</span>',
          '  <strong>#' + orderNumber + '</strong>',
          '</div>',
          '',
          '<div class="qr-container">',
          '  <img src="' + qrUrl + '" alt="QR Thanh to√°n">',
          '  <p class="qr-tip">M·ªü app ng√¢n h√†ng ‚Üí Qu√©t m√£ ‚Üí X√°c nh·∫≠n</p>',
          '</div>',
          '',
          '<div class="countdown-box">',
          '  <div class="countdown-label">Th·ªùi gian thanh to√°n c√≤n l·∫°i</div>',
          '  <div class="countdown-timer" id="countdown">--:--:--</div>',
          '  <p class="countdown-note">ƒê∆°n h√†ng s·∫Ω t·ª± ƒë·ªông h·ªßy khi h·∫øt th·ªùi gian</p>',
          '</div>',
          '',
          '<div class="divider"></div>',
          '',
          '<div class="bank-info">',
          '  <div class="info-row">',
          '    <span class="info-label">Ng√¢n h√†ng</span>',
          '    <span class="info-value">Vietcombank</span>',
          '  </div>',
          '  <div class="info-row">',
          '    <span class="info-label">S·ªë t√†i kho·∫£n</span>',
          '    <span class="info-value">',
          '      1074286868',
          '      <button class="copy-btn" onclick="copyText(\'1074286868\', this)">Copy</button>',
          '    </span>',
          '  </div>',
          '  <div class="info-row">',
          '    <span class="info-label">Ch·ªß t√†i kho·∫£n</span>',
          '    <span class="info-value">CT TNHH GEM CAPITAL HOLDING</span>',
          '  </div>',
          '  <div class="info-row">',
          '    <span class="info-label">S·ªë ti·ªÅn</span>',
          '    <span class="info-value highlight">',
          '      ' + formatMoney(amount) + 'ƒë',
          '      <button class="copy-btn" onclick="copyText(\'' + amount + '\', this)">Copy</button>',
          '    </span>',
          '  </div>',
          '  <div class="info-row">',
          '    <span class="info-label">N·ªôi dung CK</span>',
          '    <span class="info-value highlight">',
          '      DH' + orderNumber,
          '      <button class="copy-btn" onclick="copyText(\'DH' + orderNumber + '\', this)">Copy</button>',
          '    </span>',
          '  </div>',
          '</div>',
          '',
          '<div class="warning-box">',
          '  <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> Vui l√≤ng nh·∫≠p ch√≠nh x√°c n·ªôi dung chuy·ªÉn kho·∫£n ',
          '  <strong>DH' + orderNumber + '</strong> ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông x√°c nh·∫≠n thanh to√°n.',
          '</div>',
          '',
          '<div class="status-box" id="status">',
          '  <span class="status-pending">',
          '    <span class="spinner"></span>',
          '    ƒêang ch·ªù thanh to√°n...',
          '  </span>',
          '</div>'
        ].join('\n');

        // Start countdown
        startCountdown(expiresAt);

        // Start polling
        setInterval(checkStatus, 10000);
        setTimeout(checkStatus, 3000);
      }

      function startCountdown(expiresAt) {
        function update() {
          var now = new Date();
          var diff = expiresAt - now;
          var el = document.getElementById('countdown');

          if (!el) return;

          if (diff <= 0) {
            el.textContent = 'H·∫øt h·∫°n';
            el.classList.add('urgent');
            return;
          }

          var hours = Math.floor(diff / (1000 * 60 * 60));
          var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          var secs = Math.floor((diff % (1000 * 60)) / 1000);

          el.textContent = pad(hours) + ':' + pad(mins) + ':' + pad(secs);

          if (hours < 1) {
            el.classList.add('urgent');
          }
        }

        update();
        setInterval(update, 1000);
      }

      function checkStatus() {
        fetch(SUPABASE_URL + '/functions/v1/payment-status?order=' + orderNumber)
          .then(function(res) { return res.json(); })
          .then(function(response) {
            if (response.success && response.data) {
              if (response.data.is_paid) {
                showPaid();
              } else if (response.data.is_verifying) {
                var statusEl = document.getElementById('status');
                if (statusEl) {
                  statusEl.innerHTML = '<span class="status-pending"><span class="spinner"></span>ƒêang x√°c minh thanh to√°n...</span>';
                }
              }
            }
          })
          .catch(function(err) {
            console.log('Status check error:', err);
          });
      }

      function showPaid() {
        container.innerHTML = [
          '<div class="status-paid">',
          '  <div class="icon">‚úÖ</div>',
          '  <h2>Thanh to√°n th√†nh c√¥ng!</h2>',
          '  <p>ƒê∆°n h√†ng #' + orderNumber + ' ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.</p>',
          '  <p style="margin-top: 12px;">C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng!</p>',
          '</div>'
        ].join('\n');
      }

      function showError(title, message) {
        container.innerHTML = [
          '<div class="error-box">',
          '  <div class="icon">‚ùå</div>',
          '  <h2>' + title + '</h2>',
          '  <p>' + message + '</p>',
          '</div>'
        ].join('\n');
      }

      function formatMoney(amount) {
        return Number(amount).toLocaleString('vi-VN');
      }

      function pad(n) {
        return n < 10 ? '0' + n : n;
      }

      // Global copy function
      window.copyText = function(text, btn) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(function() {
            btn.textContent = 'ƒê√£ copy!';
            btn.classList.add('copied');
            setTimeout(function() {
              btn.textContent = 'Copy';
              btn.classList.remove('copied');
            }, 2000);
          });
        } else {
          var input = document.createElement('input');
          input.value = text;
          document.body.appendChild(input);
          input.select();
          document.execCommand('copy');
          document.body.removeChild(input);
          btn.textContent = 'ƒê√£ copy!';
          btn.classList.add('copied');
          setTimeout(function() {
            btn.textContent = 'Copy';
            btn.classList.remove('copied');
          }, 2000);
        }
      };
    })();
  </script>
</body>
</html>
