import { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useTranslation } from '../hooks/useTranslation';
import { useAuth } from '../contexts/AuthContext';
import { Home, Gem, ShoppingBag, Handshake, BarChart3, TrendingUp, ScrollText, Zap, Bot, Fish, Settings, Lock, User, ChevronDown, LogOut, UserCircle } from 'lucide-react';
import './TopNavBar.css';

/**
 * Top Navigation Bar
 * Modern navigation menu inspired by Whale Alert design
 */
function TopNavBar() {
  const navigate = useNavigate();
  const location = useLocation();
  const { t } = useTranslation();
  const { user, profile, isAdmin, signOut } = useAuth();
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isAccountDropdownOpen, setIsAccountDropdownOpen] = useState(false);

  const isActive = (path) => location.pathname === path;

  const menuItems = [
    { id: 'home', path: '/scanner-v2', label: t('home'), icon: <Home size={18} /> },
    { id: 'pricing', path: '/pricing', label: 'Pricing', icon: <Gem size={18} /> },
    { id: 'shop', path: '/shop', label: 'Shop', icon: <ShoppingBag size={18} />, badge: 'NEW' },
    { id: 'affiliate', path: '/affiliate', label: 'Đối Tác', icon: <Handshake size={18} />, badge: 'HOT' },
    { id: 'risk-calculator', path: '/risk-calculator', label: 'Risk Calc', icon: <BarChart3 size={18} /> },
    { id: 'analytics', path: '/analytics', label: t('analytics'), icon: <TrendingUp size={18} />, badge: 'SOON' },
    { id: 'history', path: '/history', label: t('history'), icon: <ScrollText size={18} /> },

    // TIER 3 Elite Tools
    { id: 'backtesting', path: '/tier3/backtesting', label: 'Backtesting', icon: <Zap size={18} />, badge: 'VIP' },
    { id: 'ai-prediction', path: '/tier3/ai-prediction', label: 'AI Predict', icon: <Bot size={18} />, badge: 'VIP' },
    { id: 'whale-tracker', path: '/tier3/whale-tracker', label: 'Whales', icon: <Fish size={18} />, badge: 'VIP' },
  ];

  // Right menu items - Admin item only shown for admin users
  const rightMenuItems = [
    { id: 'settings', path: '/settings', label: t('settings'), icon: <Settings size={18} /> },
    ...(isAdmin() ? [{ id: 'admin', path: '/admin', label: t('admin'), icon: <Lock size={18} /> }] : []),
  ];

  const handleNavigation = (path) => {
    navigate(path);
    setIsMenuOpen(false);
  };

  return (
    <nav className="top-nav-bar">
      <div className="nav-container">

        {/* Logo */}
        <div className="nav-logo" onClick={() => handleNavigation('/scanner-v2')}>
          <div className="logo-icon"><Gem size={32} /></div>
          <div className="logo-text">
            <div
              className="logo-title heading-lg"
              style={{
                fontFamily: 'var(--font-display)',
                fontWeight: 900,
                background: 'linear-gradient(135deg, #FFFFFF 0%, #FFBD59 100%)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent',
                backgroundClip: 'text',
                textShadow: '0 0 40px rgba(255, 189, 89, 0.3)'
              }}
            >
              GEM PATTERN
            </div>
            <div className="logo-subtitle">SCANNER</div>
          </div>
        </div>

        {/* Main Menu */}
        <div className={`nav-menu ${isMenuOpen ? 'open' : ''}`}>
          {menuItems.map(item => (
            <button
              key={item.id}
              className={`nav-item ${isActive(item.path) ? 'active' : ''}`}
              onClick={() => handleNavigation(item.path)}
            >
              <span className="nav-icon">{item.icon}</span>
              <span className="nav-label">{item.label}</span>
              {item.badge && <span className="nav-badge">{item.badge}</span>}
            </button>
          ))}
        </div>

        {/* Right Menu */}
        <div className="nav-right">
          {rightMenuItems.map(item => (
            <button
              key={item.id}
              className={`nav-item ${isActive(item.path) ? 'active' : ''}`}
              onClick={() => handleNavigation(item.path)}
              title={item.label}
            >
              <span className="nav-icon">{item.icon}</span>
              <span className="nav-label-desktop">{item.label}</span>
            </button>
          ))}

          {/* User Account Dropdown */}
          {user && (
            <div className="account-dropdown-wrapper">
              <button
                className="account-dropdown-trigger"
                onClick={() => setIsAccountDropdownOpen(!isAccountDropdownOpen)}
                onBlur={() => setTimeout(() => setIsAccountDropdownOpen(false), 200)}
              >
                <div className="account-avatar">
                  {profile?.avatar_url ? (
                    <img src={profile.avatar_url} alt="Profile" />
                  ) : (
                    <User size={18} />
                  )}
                </div>
                <span className="account-name">{profile?.full_name || user?.email?.split('@')[0] || 'User'}</span>
                <ChevronDown size={16} className={`dropdown-arrow ${isAccountDropdownOpen ? 'open' : ''}`} />
              </button>

              {isAccountDropdownOpen && (
                <div className="account-dropdown-menu">
                  <button
                    className="dropdown-item"
                    onClick={() => {
                      handleNavigation('/account');
                      setIsAccountDropdownOpen(false);
                    }}
                  >
                    <User size={16} />
                    <span>Account Dashboard</span>
                  </button>
                  <button
                    className="dropdown-item"
                    onClick={() => {
                      handleNavigation('/profile');
                      setIsAccountDropdownOpen(false);
                    }}
                  >
                    <UserCircle size={16} />
                    <span>Profile</span>
                  </button>
                  <button
                    className="dropdown-item"
                    onClick={() => {
                      handleNavigation('/affiliate');
                      setIsAccountDropdownOpen(false);
                    }}
                  >
                    <Handshake size={16} />
                    <span>Affiliate</span>
                  </button>
                  <button
                    className="dropdown-item"
                    onClick={() => {
                      handleNavigation('/settings');
                      setIsAccountDropdownOpen(false);
                    }}
                  >
                    <Settings size={16} />
                    <span>Settings</span>
                  </button>
                  <div className="dropdown-divider"></div>
                  <button
                    className="dropdown-item logout"
                    onClick={() => {
                      setIsAccountDropdownOpen(false);
                      signOut();
                    }}
                  >
                    <LogOut size={16} />
                    <span>Logout</span>
                  </button>
                </div>
              )}
            </div>
          )}

          {/* Mobile Menu Toggle */}
          <button
            className="mobile-menu-toggle"
            onClick={() => setIsMenuOpen(!isMenuOpen)}
            aria-label="Toggle menu"
          >
            <span className={`hamburger ${isMenuOpen ? 'open' : ''}`}>
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
        </div>

      </div>
    </nav>
  );
}

export default TopNavBar;
