{% comment %}
  GEMRAL Cart Drawer Section
  ==========================
  Custom cart system for gemral.com landing page
  Checkout redirects to yinyangmasters.com (Shopify)

  HOW TO USE:
  1. Go to Shopify Admin > Online Store > Themes > Edit Code
  2. In "Sections" folder, click "Add a new section"
  3. Name it "cart-drawer" and paste this entire code
  4. Add to your page: {% section 'cart-drawer' %}

  Or in Theme Customizer, add this section to your page template.
{% endcomment %}

<!-- Cart Icon Button (Add this where you want the cart icon) -->
<div class="gemral-cart-icon-wrapper" id="gemral-cart-icon">
  <button class="gemral-cart-icon-btn" onclick="gemralOpenCart()" aria-label="Mở giỏ hàng">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="9" cy="21" r="1"/>
      <circle cx="20" cy="21" r="1"/>
      <path d="m1 1 4 0 2.68 13.39a2 2 0 0 0 2 1.61l9.72 0a2 2 0 0 0 2-1.61L23 6 6 6"/>
    </svg>
    <span class="gemral-cart-count" id="gemral-cart-count" style="display: none;">0</span>
  </button>
</div>

<!-- Cart Overlay -->
<div class="gemral-cart-overlay" id="gemral-cart-overlay" onclick="gemralCloseCart()"></div>

<!-- Cart Drawer -->
<aside class="gemral-cart-drawer" id="gemral-cart-drawer" aria-label="Giỏ hàng">
  <!-- Header -->
  <div class="gemral-cart-header">
    <h3>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
        <path d="m1 1 4 0 2.68 13.39a2 2 0 0 0 2 1.61l9.72 0a2 2 0 0 0 2-1.61L23 6 6 6"/>
      </svg>
      Giỏ Hàng
    </h3>
    <button class="gemral-cart-close-btn" onclick="gemralCloseCart()" aria-label="Đóng giỏ hàng">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>

  <!-- Empty State -->
  <div class="gemral-cart-empty" id="gemral-cart-empty">
    <svg class="gemral-cart-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
      <path d="m1 1 4 0 2.68 13.39a2 2 0 0 0 2 1.61l9.72 0a2 2 0 0 0 2-1.61L23 6 6 6"/>
    </svg>
    <h4 class="gemral-cart-empty-title">Giỏ hàng trống</h4>
    <p class="gemral-cart-empty-text">Hãy khám phá các sản phẩm của chúng tôi!</p>
  </div>

  <!-- Cart Content -->
  <div class="gemral-cart-content" id="gemral-cart-content" style="display: none;">
    <div class="gemral-cart-items" id="gemral-cart-items">
      <!-- Items rendered by JavaScript -->
    </div>
  </div>

  <!-- Footer -->
  <div class="gemral-cart-footer">
    <div class="gemral-cart-total-row">
      <span class="gemral-cart-total-label">Tổng cộng:</span>
      <span class="gemral-cart-total" id="gemral-cart-total">0đ</span>
    </div>

    <button class="gemral-btn-checkout" id="gemral-checkout-btn" onclick="gemralCheckout()" disabled>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
        <line x1="1" y1="10" x2="23" y2="10"/>
      </svg>
      Thanh Toán
    </button>

     </div>
</aside>

{% comment %} ═══════════════════════════════════════════════════════════════════
  STYLES - Inline CSS for Shopify
═══════════════════════════════════════════════════════════════════ {% endcomment %}

<style>
  /* ═══════════════════════════════════════════════════════════════════════════
     GEMRAL CART - CSS Variables
     ═══════════════════════════════════════════════════════════════════════════ */

  :root {
    --gemral-navy: #112250;
    --gemral-navy-light: #1a3366;
    --gemral-navy-dark: #0a1530;
    --gemral-gold: #FFBD59;
    --gemral-gold-dark: #e6a94d;
    --gemral-burgundy: #9C0612;
    --gemral-cyan: #00F0FF;
    --gemral-white: #ffffff;
    --gemral-gray: rgba(255, 255, 255, 0.6);
    --gemral-border: rgba(255, 189, 89, 0.2);
    --gemral-success: #22c55e;
    --gemral-error: #ef4444;
    --gemral-info: #3b82f6;
    --gemral-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    --gemral-transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART ICON
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-icon-wrapper {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9998;
  }

  .gemral-cart-icon-btn {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    background: rgba(255, 189, 89, 0.15);
    border: 2px solid var(--gemral-gold);
    border-radius: 14px;
    cursor: pointer;
    transition: var(--gemral-transition);
    color: var(--gemral-gold);
    box-shadow: 0 4px 20px rgba(255, 189, 89, 0.3);
  }

  .gemral-cart-icon-btn:hover {
    background: rgba(255, 189, 89, 0.25);
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(255, 189, 89, 0.4);
  }

  .gemral-cart-icon-btn svg {
    width: 24px;
    height: 24px;
  }

  .gemral-cart-count {
    position: absolute;
    top: -8px;
    right: -8px;
    min-width: 22px;
    height: 22px;
    padding: 0 6px;
    background: var(--gemral-burgundy);
    color: var(--gemral-white);
    font-size: 12px;
    font-weight: 700;
    border-radius: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(156, 6, 18, 0.6);
    animation: gemral-badge-pop 0.3s ease;
  }

  @keyframes gemral-badge-pop {
    0% { transform: scale(0); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART DRAWER
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-drawer {
    position: fixed;
    top: 0;
    right: -420px;
    width: 400px;
    max-width: 100vw;
    height: 100vh;
    background: linear-gradient(180deg, var(--gemral-navy) 0%, var(--gemral-navy-dark) 100%);
    border-left: 1px solid var(--gemral-border);
    z-index: 10001;
    display: flex;
    flex-direction: column;
    transition: right var(--gemral-transition);
    box-shadow: var(--gemral-shadow);
  }

  .gemral-cart-drawer.open {
    right: 0;
  }

  .gemral-cart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: var(--gemral-transition);
  }

  .gemral-cart-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART HEADER
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--gemral-border);
    background: rgba(255, 189, 89, 0.05);
  }

  .gemral-cart-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: var(--gemral-gold);
  }

  .gemral-cart-close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 10px;
    cursor: pointer;
    color: var(--gemral-white);
    transition: var(--gemral-transition);
  }

  .gemral-cart-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    color: var(--gemral-gold);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART EMPTY STATE
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
    text-align: center;
  }

  .gemral-cart-empty-icon {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    color: var(--gemral-gray);
    opacity: 0.5;
  }

  .gemral-cart-empty-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--gemral-white);
    margin: 0 0 8px 0;
  }

  .gemral-cart-empty-text {
    font-size: 14px;
    color: var(--gemral-gray);
    margin: 0;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART CONTENT
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .gemral-cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
  }

  .gemral-cart-items::-webkit-scrollbar {
    width: 6px;
  }

  .gemral-cart-items::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }

  .gemral-cart-items::-webkit-scrollbar-thumb {
    background: rgba(255, 189, 89, 0.3);
    border-radius: 3px;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART ITEM
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-item {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: var(--gemral-transition);
  }

  .gemral-cart-item:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: var(--gemral-border);
  }

  .gemral-cart-item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.1);
  }

  .gemral-cart-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gemral-cart-item-details {
    flex: 1;
    min-width: 0;
  }

  .gemral-cart-item-name {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 600;
    color: var(--gemral-white);
    text-decoration: none;
    transition: var(--gemral-transition);
    line-height: 1.3;
  }

  .gemral-cart-item-name:hover {
    color: var(--gemral-gold);
  }

  .gemral-cart-item-name .external-link-icon {
    opacity: 0;
    transition: var(--gemral-transition);
    flex-shrink: 0;
  }

  .gemral-cart-item-name:hover .external-link-icon {
    opacity: 1;
  }

  .gemral-cart-item-price {
    display: block;
    font-size: 14px;
    font-weight: 700;
    color: var(--gemral-gold);
    margin-top: 4px;
  }

  .gemral-cart-item-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
  }

  .gemral-quantity-control {
    display: flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 4px;
  }

  .gemral-qty-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: var(--gemral-white);
    transition: var(--gemral-transition);
  }

  .gemral-qty-btn:hover {
    background: var(--gemral-gold);
    color: var(--gemral-navy);
  }

  .gemral-qty-value {
    min-width: 30px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--gemral-white);
  }

  .gemral-remove-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(156, 6, 18, 0.2);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: var(--gemral-burgundy);
    transition: var(--gemral-transition);
  }

  .gemral-remove-btn:hover {
    background: var(--gemral-burgundy);
    color: var(--gemral-white);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CART FOOTER
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-cart-footer {
    padding: 20px 24px;
    border-top: 1px solid var(--gemral-border);
    background: rgba(0, 0, 0, 0.2);
  }

  .gemral-cart-total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .gemral-cart-total-label {
    font-size: 16px;
    color: var(--gemral-white);
  }

  .gemral-cart-total {
    font-size: 22px;
    font-weight: 700;
    color: var(--gemral-gold);
  }

  .gemral-btn-checkout {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px 24px;
    background: linear-gradient(135deg, var(--gemral-gold) 0%, var(--gemral-gold-dark) 100%);
    color: var(--gemral-navy-dark);
    font-size: 16px;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--gemral-transition);
  }

  .gemral-btn-checkout:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 189, 89, 0.4);
  }

  .gemral-btn-checkout:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .gemral-cart-note {
    text-align: center;
    font-size: 12px;
    color: var(--gemral-gray);
    margin: 12px 0 0 0;
  }

  .gemral-cart-note a {
    color: var(--gemral-cyan);
    text-decoration: none;
  }

  .gemral-cart-note a:hover {
    text-decoration: underline;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     TOAST NOTIFICATIONS
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    background: var(--gemral-navy-light);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    z-index: 10002;
    transform: translateY(100px);
    opacity: 0;
    transition: var(--gemral-transition);
  }

  .gemral-toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .gemral-toast--success { border-left: 4px solid var(--gemral-success); }
  .gemral-toast--error { border-left: 4px solid var(--gemral-error); }
  .gemral-toast--info { border-left: 4px solid var(--gemral-info); }

  .gemral-toast-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .gemral-toast--success .gemral-toast-icon { color: var(--gemral-success); }
  .gemral-toast--error .gemral-toast-icon { color: var(--gemral-error); }
  .gemral-toast--info .gemral-toast-icon { color: var(--gemral-info); }

  .gemral-toast-message {
    font-size: 14px;
    color: var(--gemral-white);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     ADD TO CART BUTTON (for pricing cards)
     ═══════════════════════════════════════════════════════════════════════════ */

  .gemral-btn-add-cart {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, var(--gemral-gold) 0%, var(--gemral-gold-dark) 100%);
    color: var(--gemral-navy-dark);
    font-size: 15px;
    font-weight: 700;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--gemral-transition);
    text-decoration: none;
  }

  .gemral-btn-add-cart:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 189, 89, 0.5);
  }

  .gemral-btn-add-cart svg {
    width: 18px;
    height: 18px;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (max-width: 480px) {
    .gemral-cart-drawer {
      width: 100%;
      right: -100%;
    }

    .gemral-cart-item {
      flex-wrap: wrap;
    }

    .gemral-cart-item-actions {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .gemral-toast {
      left: 16px;
      right: 16px;
      bottom: 16px;
    }

    .gemral-cart-icon-wrapper {
      top: 15px;
      right: 15px;
    }

    .gemral-cart-icon-btn {
      width: 46px;
      height: 46px;
    }
  }
</style>

{% comment %} ═══════════════════════════════════════════════════════════════════
  JAVASCRIPT - Cart Service
═══════════════════════════════════════════════════════════════════ {% endcomment %}

<script>
(function() {
  'use strict';

  // ═══════════════════════════════════════════════════════════════════════════
  // CONSTANTS
  // ═══════════════════════════════════════════════════════════════════════════

  const SHOP_DOMAIN = 'yinyangmasters.com';
  const STORAGE_KEY = 'gemral_cart';
  const REFERRAL_KEY = 'gemral_referral';

  // ═══════════════════════════════════════════════════════════════════════════
  // PRODUCT CATALOG - All Shopify Variant IDs
  // ═══════════════════════════════════════════════════════════════════════════

  const PRODUCT_CATALOG = {
    // KHÓA HỌC TRADING
    'course-starter': {
      id: 'course-starter',
      name: 'Khóa Học Trading - Starter',
      price: 299000,
      priceDisplay: '299.000đ',
      variantId: '46448154050737',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-trading-course-tier-starter',
      image: ''
    },
    'course-tier1': {
      id: 'course-tier1',
      name: 'Khóa Học Trading - Tier 1',
      price: 11000000,
      priceDisplay: '11.000.000đ',
      variantId: '46351707898033',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-tier1',
      image: ''
    },
    'course-tier2': {
      id: 'course-tier2',
      name: 'Khóa Học Trading - Tier 2',
      price: 21000000,
      priceDisplay: '21.000.000đ',
      variantId: '46351719235761',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-tier2',
      image: ''
    },
    'course-tier3': {
      id: 'course-tier3',
      name: 'Khóa Học Trading - Tier 3',
      price: 68000000,
      priceDisplay: '68.000.000đ',
      variantId: '46351723331761',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-tier3',
      image: ''
    },

    // GEM MASTER Sư Phụ AI
    'chatbot-pro': {
      id: 'chatbot-pro',
      name: 'GEM MASTER Sư Phụ AI - PRO',
      price: 39000,
      priceDisplay: '39.000đ/tháng',
      variantId: '46351763701937',
      shopifyUrl: 'https://yinyangmasters.com/products/yinyang-chatbot-ai-pro',
      image: ''
    },
    'chatbot-premium': {
      id: 'chatbot-premium',
      name: 'GEM MASTER Sư Phụ AI - PREMIUM',
      price: 59000,
      priceDisplay: '59.000đ/tháng',
      variantId: '46351771893937',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-chatbot-premium',
      image: ''
    },
    'chatbot-vip': {
      id: 'chatbot-vip',
      name: 'GEM MASTER Sư Phụ AI - VIP',
      price: 99000,
      priceDisplay: '99.000đ/tháng',
      variantId: '46421822832817',
      shopifyUrl: 'https://yinyangmasters.com/products/yinyang-chatbot-ai-vip',
      image: ''
    },

    // SCANNER DASHBOARD
    'scanner-pro': {
      id: 'scanner-pro',
      name: 'Scanner Dashboard - Pro',
      price: 997000,
      priceDisplay: '997.000đ/tháng',
      variantId: '46351752069297',
      shopifyUrl: 'https://yinyangmasters.com/products/gem-scanner-pro',
      image: ''
    },
    'scanner-premium': {
      id: 'scanner-premium',
      name: 'Scanner Dashboard - Premium',
      price: 1997000,
      priceDisplay: '1.997.000đ/tháng',
      variantId: '46351759507633',
      shopifyUrl: 'https://yinyangmasters.com/products/scanner-dashboard-premium',
      image: ''
    },
    'scanner-vip': {
      id: 'scanner-vip',
      name: 'Scanner Dashboard - VIP',
      price: 5997000,
      priceDisplay: '5.997.000đ/tháng',
      variantId: '46351760294065',
      shopifyUrl: 'https://yinyangmasters.com/products/scanner-dashboard-vip',
      image: ''
    },

    // KHÓA HỌC TÂM LINH / TƯ DUY
    'mindset-7days': {
      id: 'mindset-7days',
      name: '7 Ngày Khai Mở Tần Số Gốc',
      price: 1990000,
      priceDisplay: '1.990.000đ',
      variantId: '46448176758961',
      shopifyUrl: 'https://yinyangmasters.com/products/khoa-hoc-7-ngay-khai-mo-tan-so-goc',
      image: ''
    },
    'mindset-love': {
      id: 'mindset-love',
      name: 'Kích Hoạt Tần Số Tình Yêu',
      price: 399000,
      priceDisplay: '399.000đ',
      variantId: '46448180166833',
      shopifyUrl: 'https://yinyangmasters.com/products/khoa-hoc-kich-hoat-tan-so-tinh-yeu',
      image: ''
    },
    'mindset-wealth': {
      id: 'mindset-wealth',
      name: 'Tái Tạo Tư Duy Triệu Phú',
      price: 499000,
      priceDisplay: '499.000đ',
      variantId: '46448192192689',
      shopifyUrl: 'https://yinyangmasters.com/products/khoa-hoc-tai-tao-tu-duy-trieu-phu',
      image: ''
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // CART STATE
  // ═══════════════════════════════════════════════════════════════════════════

  let cart = loadCart();

  function loadCart() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      return [];
    }
  }

  function saveCart() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
      updateCartUI();
    } catch (e) {
      console.error('[GemralCart] Error saving:', e);
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // CART OPERATIONS
  // ═══════════════════════════════════════════════════════════════════════════

  function addItem(productId, quantity) {
    quantity = quantity || 1;
    const product = PRODUCT_CATALOG[productId];

    if (!product) {
      showToast('Không tìm thấy sản phẩm', 'error');
      return false;
    }

    const existingIndex = cart.findIndex(function(item) { return item.id === productId; });

    if (existingIndex >= 0) {
      cart[existingIndex].quantity += quantity;
    } else {
      cart.push({
        id: productId,
        name: product.name,
        price: product.price,
        priceDisplay: product.priceDisplay,
        variantId: product.variantId,
        shopifyUrl: product.shopifyUrl,
        image: product.image,
        quantity: quantity
      });
    }

    saveCart();
    showToast('Đã thêm "' + product.name + '" vào giỏ hàng', 'success');
    return true;
  }

  function removeItem(productId) {
    const item = cart.find(function(i) { return i.id === productId; });
    cart = cart.filter(function(i) { return i.id !== productId; });
    saveCart();
    if (item) {
      showToast('Đã xóa "' + item.name + '" khỏi giỏ hàng', 'info');
    }
  }

  function updateQuantity(productId, quantity) {
    if (quantity <= 0) {
      removeItem(productId);
      return;
    }
    const item = cart.find(function(i) { return i.id === productId; });
    if (item) {
      item.quantity = quantity;
      saveCart();
    }
  }

  function clearCart() {
    cart = [];
    saveCart();
    showToast('Đã xóa toàn bộ giỏ hàng', 'info');
  }

  function getTotal() {
    return cart.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
  }

  function getCount() {
    return cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // CHECKOUT
  // ═══════════════════════════════════════════════════════════════════════════

  function generateCheckoutURL() {
    if (cart.length === 0) return null;

    const items = cart.map(function(item) {
      return item.variantId + ':' + item.quantity;
    }).join(',');

    const refCode = sessionStorage.getItem(REFERRAL_KEY) ||
                    localStorage.getItem(REFERRAL_KEY) ||
                    localStorage.getItem('referral_code') ||
                    getUrlParam('ref') ||
                    getUrlParam('referral');

    let url = 'https://' + SHOP_DOMAIN + '/cart/' + items;
    if (refCode) {
      url += '?ref=' + encodeURIComponent(refCode);
    }
    return url;
  }

  function getUrlParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param) || '';
  }

  function checkout() {
    const url = generateCheckoutURL();
    if (!url) {
      showToast('Giỏ hàng trống!', 'error');
      return;
    }
    window.location.href = url;
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // UI UPDATES
  // ═══════════════════════════════════════════════════════════════════════════

  function updateCartUI() {
    updateCartBadge();
    renderCartDrawer();
  }

  function updateCartBadge() {
    const badge = document.getElementById('gemral-cart-count');
    if (badge) {
      const count = getCount();
      badge.textContent = count;
      badge.style.display = count > 0 ? 'flex' : 'none';
    }
  }

  function renderCartDrawer() {
    const cartItems = document.getElementById('gemral-cart-items');
    const cartTotal = document.getElementById('gemral-cart-total');
    const cartEmpty = document.getElementById('gemral-cart-empty');
    const cartContent = document.getElementById('gemral-cart-content');
    const checkoutBtn = document.getElementById('gemral-checkout-btn');

    if (!cartItems) return;

    if (cart.length === 0) {
      if (cartEmpty) cartEmpty.style.display = 'flex';
      if (cartContent) cartContent.style.display = 'none';
      if (checkoutBtn) checkoutBtn.disabled = true;
      return;
    }

    if (cartEmpty) cartEmpty.style.display = 'none';
    if (cartContent) cartContent.style.display = 'flex';
    if (checkoutBtn) checkoutBtn.disabled = false;

    cartItems.innerHTML = cart.map(function(item) {
      return '<div class="gemral-cart-item" data-id="' + item.id + '">' +
        '<div class="gemral-cart-item-details">' +
          '<a href="' + item.shopifyUrl + '" target="_blank" rel="noopener" class="gemral-cart-item-name">' +
            item.name +
            '<svg class="external-link-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
              '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>' +
              '<polyline points="15 3 21 3 21 9"/>' +
              '<line x1="10" y1="14" x2="21" y2="3"/>' +
            '</svg>' +
          '</a>' +
          '<span class="gemral-cart-item-price">' + item.priceDisplay + '</span>' +
        '</div>' +
        '<div class="gemral-cart-item-actions">' +
          '<div class="gemral-quantity-control">' +
            '<button class="gemral-qty-btn" onclick="gemralUpdateQty(\'' + item.id + '\', ' + (item.quantity - 1) + ')">' +
              '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
            '</button>' +
            '<span class="gemral-qty-value">' + item.quantity + '</span>' +
            '<button class="gemral-qty-btn" onclick="gemralUpdateQty(\'' + item.id + '\', ' + (item.quantity + 1) + ')">' +
              '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
            '</button>' +
          '</div>' +
          '<button class="gemral-remove-btn" onclick="gemralRemoveItem(\'' + item.id + '\')">' +
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
              '<polyline points="3 6 5 6 21 6"/>' +
              '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' +
            '</svg>' +
          '</button>' +
        '</div>' +
      '</div>';
    }).join('');

    if (cartTotal) {
      cartTotal.textContent = formatPrice(getTotal());
    }
  }

  function formatPrice(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // DRAWER CONTROL
  // ═══════════════════════════════════════════════════════════════════════════

  function openCart() {
    const drawer = document.getElementById('gemral-cart-drawer');
    const overlay = document.getElementById('gemral-cart-overlay');
    if (drawer) {
      drawer.classList.add('open');
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeCart() {
    const drawer = document.getElementById('gemral-cart-drawer');
    const overlay = document.getElementById('gemral-cart-overlay');
    if (drawer) {
      drawer.classList.remove('open');
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // TOAST
  // ═══════════════════════════════════════════════════════════════════════════

  function showToast(message, type) {
    type = type || 'info';
    var existing = document.querySelectorAll('.gemral-toast');
    existing.forEach(function(t) { t.remove(); });

    var icons = {
      success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
      error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
      info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
    };

    var toast = document.createElement('div');
    toast.className = 'gemral-toast gemral-toast--' + type;
    toast.innerHTML = '<span class="gemral-toast-icon">' + (icons[type] || icons.info) + '</span>' +
                      '<span class="gemral-toast-message">' + message + '</span>';

    document.body.appendChild(toast);
    requestAnimationFrame(function() { toast.classList.add('show'); });

    setTimeout(function() {
      toast.classList.remove('show');
      setTimeout(function() { toast.remove(); }, 300);
    }, 3000);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GLOBAL FUNCTIONS (for onclick handlers)
  // ═══════════════════════════════════════════════════════════════════════════

  window.gemralAddToCart = addItem;
  window.gemralRemoveItem = removeItem;
  window.gemralUpdateQty = updateQuantity;
  window.gemralOpenCart = openCart;
  window.gemralCloseCart = closeCart;
  window.gemralCheckout = checkout;
  window.gemralClearCart = clearCart;

  // Initialize on load
  updateCartUI();

  // Cross-tab sync
  window.addEventListener('storage', function(e) {
    if (e.key === STORAGE_KEY) {
      cart = loadCart();
      updateCartUI();
    }
  });

  console.log('[GemralCart] Initialized with', cart.length, 'items');

})();
</script>

{% schema %}
{
  "name": "GEMRAL Cart Drawer",
  "tag": "div",
  "class": "gemral-cart-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_cart_icon",
      "label": "Show floating cart icon",
      "default": true
    },
    {
      "type": "range",
      "id": "icon_top",
      "label": "Cart icon position from top (px)",
      "min": 10,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "icon_right",
      "label": "Cart icon position from right (px)",
      "min": 10,
      "max": 100,
      "step": 5,
      "default": 20
    }
  ],
  "presets": [
    {
      "name": "GEMRAL Cart Drawer",
      "category": "Custom"
    }
  ]
}
{% endschema %}
